{% extends "plantilla.html" %}
{% block content %}
{% load static %}

<div class="container mt-4">
    <h2>Mapa de Centrales</h2>
    <div id="map" style="height: 500px; width: 100%; border-radius: 12px;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Centra el mapa en Ecuador
    var map = L.map('map').setView([-1.831239, -78.183406], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Agrega los pines de todas las centrales
    {% for central in centrales %}
        {% if central.localizacion and "," in central.localizacion %}
            (function() {
                var loc = "{{ central.localizacion|cut:' ' }}";
                var parts = loc.split(",");
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    var lat = parseFloat(parts[0]);
                    var lng = parseFloat(parts[1]);
                    var popupContent = `
                        <div style="text-align:center;">
                            <h5>{{ central.nombre }}</h5>
                            <p><b>Tipo:</b> {{ central.tipo_electrica.nombre }}</p>
                            {% if central.foto_central %}
                                <img src="{{ central.foto_central.url }}" alt="Foto Central" style="width:120px; border-radius:8px;">
                            {% endif %}
                            <br>
                            {% if central.fotovoltaica %}
                                <a href="{% url 'fotovoltaica_list' %}?nombre={{ central.nombre|urlencode }}" class="btn btn-primary mt-2" style="color:white;">
                                    Ver datos
                                </a>
                            {% endif %}
                        </div>
                    `;
                    L.marker([lat, lng]).addTo(map).bindPopup(popupContent);
                }
            })();
        {% endif %}
    {% endfor %}
});
</script>
{% endblock %}